@page "/dashboard"
@using Journal.Models
@using Journal.Services
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject IAnalyticsService AnalyticsService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="dashboard-container">
    <div class="dashboard-content">
        <h1 class="title">Welcome, @currentUser?.FullName</h1>
        <p class="subtitle">Here’s a quick overview of your journal activities.</p>

        <div class="dashboard-actions">
            <button class="btn primary-btn" @onclick="NavigateToNewJournal">New Journal Entry</button>
            <button class="btn primary-btn" @onclick="NavigateToJournalList">View All Journals</button>
        </div>

        <div class="mood-chart">
            @if (chartRendered == false)
            {
                <div class="chart-loading">
                    Loading chart…
                </div>
            }
            <canvas id="moodChart"></canvas>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card">
                <h3>Total Entries</h3>
                <p>@totalJournals</p>
            </div>
            <div class="stat-card">
                <h3>Recent Entry</h3>
                <p>@recentJournal?.Title</p>
            </div>
        </div>

        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var journal in @journals)
                {
                    <tr>
                        <td>@journal.Title</td>
                        <td>@journal.CreatedAt.ToShortDateString()</td>
                        <td>
                            <button class="dashboard-btn">Edit</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@code {
    private User? currentUser;
    private int totalJournals;
    private JournalEntry? recentJournal;
    private List<JournalEntry> journals = new List<JournalEntry>();
    private Dictionary<string, double> moodDistribution = new Dictionary<string, double>();

    private bool chartRendered;

    protected async override Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        journals = await JournalService.GetAllJournalsAsync(currentUser.Id);
        totalJournals = journals.Count;
        recentJournal = journals.OrderByDescending(j => j.CreatedAt).FirstOrDefault();

        moodDistribution = AnalyticsService.GetMoodDistribution(journals);
        chartRendered = false;

        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (chartRendered) return;


        var labels = moodDistribution.Keys.ToArray();
        var values = moodDistribution.Values.ToArray();
           
        chartRendered = true;

        await InvokeAsync(StateHasChanged);

        await JS.InvokeVoidAsync(
            "renderMoodChart",
            "moodChart",
            labels,
            values,
            "pie" 
        );
    }

    private void NavigateToNewJournal() => Navigation.NavigateTo("/journal/add");
    private void NavigateToJournalList() => Navigation.NavigateTo("/journal/list");
}
