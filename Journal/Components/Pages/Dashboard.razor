@page "/dashboard"
@using Journal.Models
@using Journal.Services
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject IAnalyticsService AnalyticsService
@inject NavigationManager Navigation
@inject IJSRuntime JS

@if (_isLoading)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading your dashboard...</p>
    </div>
}
else
{
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="title">Welcome back, @_currentUser?.FullName</h1>
                <p class="subtitle">Here's your journaling journey at a glance</p>
            </div>
            <div class="header-actions">
                <a class="btn btn-secondary" href="/change-password">
                    Change Password
                </a>
            </div>
        </div>

        <div class="dashboard-main">
            <!-- Stats -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa-solid fa-chart-simple" style="color: var(--accent)"></i></div>
                    <div class="stat-content">
                        <p class="stat-label">Total Entries</p>
                        <p class="stat-value">@_totalJournalCount</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon"><i class="fa-solid fa-fire" style="color: red;"></i></div>
                    <div class="stat-content">
                        <p class="stat-label">Current Streak</p>
                        <p class="stat-value">@_currentStreak <span class="stat-unit">days</span></p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon"><i class="fa-solid fa-trophy" style="color: gold;"></i></div>
                    <div class="stat-content">
                        <p class="stat-label">Longest Streak</p>
                        <p class="stat-value">@_longestStreak <span class="stat-unit">days</span></p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid @(_mostFrequentMood == string.Empty ? "fa-meh" : Util.GetMoodIcon(_mostFrequentMood))" style="color: var(--accent)"></i>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label">Top Mood</p>
                        <p class="stat-value mood-text">@(_mostFrequentMood == string.Empty ? "-" : _mostFrequentMood)</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-row">
                <div class="chart-section">
                    <div class="section-header">
                        <h2 class="section-title">Mood Distribution</h2>
                    </div>
                    <div class="chart-container">
                        @if (_totalJournalCount == 0 || _moodDistribution == null || !_moodDistribution.Any())
                        {
                            <div class="empty-state">
                                <i class="fa-solid fa-chart-pie empty-icon" style="font-size: 40px; color: var(--accent);"></i>
                                <p class="empty-text">No entries yet, so there’s no mood data to show.</p>
                            </div>
                        }
                        else
                        {
                            @if (_chartRendered == false)
                            {
                                <div class="chart-loading">
                                    <div class="loading-spinner small"></div>
                                    <p>Loading chart...</p>
                                </div>
                            }

                            <canvas id="moodChart"></canvas>
                        }
                    </div>
                </div>

                <div class="recent-section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Entries</h2>
                        <span class="section-count">Last 5</span>
                    </div>

                    @if (_recentJournals.Any())
                    {
                        <div class="entries-list">
                            @foreach (var journal in _recentJournals)
                            {
                                <div class="entry-card">
                                    <div class="entry-header">
                                        <h3 class="entry-title">@journal.Title</h3>
                                        <span class="entry-date">@journal.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <div class="entry-actions">
                                        <a class="btn-link" href="@($"journal/{journal.Id}")">View</a>
                                        <a class="btn-link" href="@($"/journal/edit/{journal.Id}")">Edit</a>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <i class="fa-solid fa-note-sticky empty-icon" style="font-size: 40px; color: var(--accent);"></i>
                            <p class="empty-text">No entries yet. Start journaling today!</p>
                        </div>
                    }
                </div>
            </div>

            <div class="dashboard-row">
                <div class="chart-section">
                    <div class="section-header">
                        <h2 class="section-title">Word Count Trend</h2>
                    </div>
                    <div class="chart-container">
                        @if (_totalJournalCount == 0 || _averageWordCount == null || !_averageWordCount.Any())
                        {
                            <div class="empty-state">
                                <i class="fa-solid fa-chart-line empty-icon" style="font-size: 40px; color: var(--accent);"></i>
                                <p class="empty-text">No entries yet, so there’s no word count data to show.</p>
                            </div>
                        }
                        else
                        {
                            @if (_chartRendered == false)
                            {
                                <div class="chart-loading">
                                    <div class="loading-spinner small"></div>
                                    <p>Loading chart...</p>
                                </div>
                            }

                            <canvas id="wordCountChart"></canvas>
                        }
                    </div>
                </div>

                <div class="chart-section">
                    <div class="section-header">
                        <h2 class="section-title">Most Used Tags</h2>
                    </div>

                    <div class="chart-container">
                        @if (_tagsFrequency == null || !_tagsFrequency.Any())
                        {
                            <div class="empty-state">
                                <i class="fa-solid fa-tags empty-icon" style="font-size: 40px; color: var(--accent);"></i>
                                <p class="empty-text">No tags yet, so there’s nothing to show.</p>
                            </div>
                        }
                        else
                        {
                            <canvas id="tagsChart"></canvas>
                        }
                    </div>
                </div>
            </div>

            <!-- Missed Days -->
            @if (_missedDays.Any())
            {
                <div class="missed-section">
                    <div class="section-header">
                        <h2 class="section-title">Missed Days</h2>
                        <span class="section-badge">@_missedDays.Count</span>
                    </div>
                    <div class="missed-list">
                        @foreach (var missedDay in _missedDays.Take(7))
                        {
                            <div class="missed-item">
                                <span class="missed-dot"></span>
                                <span class="missed-date">@missedDay.ToString("dddd, MMM dd yyyy")</span>
                            </div>
                        }
                        @if (_missedDays.Count > 7)
                        {
                            <div class="missed-more">
                                +@(_missedDays.Count - 7) more missed days
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    // Current logged in user
    private User? _currentUser;

    // Flag to show loading 
    private bool _isLoading = true;

    // Journals of all users
    private List<JournalEntry> _journals = new();

    // Last 5 recent journals
    private List<JournalEntry> _recentJournals = new();

    // Total number of entries
    private int _totalJournalCount;

    // Most frequent mood 
    private string _mostFrequentMood = string.Empty;

    // Mood distribution data for chart
    private Dictionary<string, double>? _moodDistribution;

    // Flag to prevent multiple chart render
    private bool _chartRendered;

    // Current and longest streak 
    private int _currentStreak;
    private int _longestStreak;

    // Missed days 
    private List<DateTime> _missedDays = new();

    // Average word count 
    private Dictionary<string, double> _averageWordCount = new();

    // Tags frequency
    private Dictionary<string, int> _tagsFrequency = new();

    // Initialize data for dashboard
    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUser();
        if (_currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        // Fetch journals
        _journals = await JournalService.GetAllJournalsAsync(_currentUser.Id);
        
        // Total journals
        _totalJournalCount = _journals.Count;

        // 5 Recent journals 
        _recentJournals = _journals.OrderByDescending(j => j.CreatedAt).Take(5).ToList();

        // Most frequent mood
        _mostFrequentMood = AnalyticsService.GetMostFrequentMood(_journals) ?? string.Empty;
        // Mood data for chart
        _moodDistribution = AnalyticsService.GetMoodDistribution(_journals);
        // Current streak 
        _currentStreak = AnalyticsService.GetCurrentDailyStreak(_journals);
        // Longest Streak
        _longestStreak = AnalyticsService.GetLongestStreak(_journals);
        // Missed days 
        _missedDays = AnalyticsService.GetMissedDays(_journals);
        // Word count for journals for chart
        _averageWordCount = AnalyticsService.GetAverageWordCountPerDay(_journals);
        // Tags frequency of journals
        _tagsFrequency = AnalyticsService.GetTagFrequency(_journals);

        // Set loading to false after loading data
        _isLoading = false;
    }

    // Render charts once after data is loaded
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // If chart is rendered then return
        if (_chartRendered) return;
        if (_moodDistribution == null || !_moodDistribution.Any() || _averageWordCount == null || !_averageWordCount.Any()) return;

        var labels = _moodDistribution.Keys.ToArray();
        var values = _moodDistribution.Values.ToArray();

        _chartRendered = true;

        await InvokeAsync(StateHasChanged);

        // Mood distribution chart
        await JS.InvokeVoidAsync(
            "renderMoodChart",
            "moodChart",
            labels,
            values,
            "pie"
        );

        var ordered = _averageWordCount.OrderBy(count => count.Key).Take(15).ToArray();

        var wordLabels = ordered.Select(count => count.Key).ToArray();
        var wordValues = ordered.Select(count => count.Value).ToArray();

        // Word count trend chart
        await JS.InvokeVoidAsync(
            "renderWordCountTrend",
            "wordCountChart",
            wordLabels,
            wordValues
        );

        var topTags = _tagsFrequency.OrderByDescending(tag => tag.Value).Take(10).ToArray();

        var tagLabels = topTags.Select(tag => tag.Key).ToArray();
        var tagValues = topTags.Select(tag => (double)tag.Value).ToArray();

        // Most used tags chart
        await JS.InvokeVoidAsync(
            "renderTagsChart",
            "tagsChart",
            tagLabels,
            tagValues
        );
    }
}
