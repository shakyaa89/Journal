@page "/journal/edit/{Id:int}"
@using Journal.Models
@using Journal.Services
@inject NavigationManager Navigation
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject IJSRuntime JS

<div class="journal-container">
    <div class="journal-sidebar">

        <div class="sidebar-card">
            <div class="card-header">
                <label>DATE</label>
            </div>
            <div class="date-picker">
                <span class="date-icon"><i class="fa-solid fa-calendar"></i></span>
                <div class="date-info">
                    <div class="date-text">@_journal.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</div>
                    <div class="date-subtext">Original entry date</div>
                </div>
            </div>
        </div>

        <div class="sidebar-card">
            <div class="card-header">
                <label>PRIMARY MOOD <span class="required">*</span></label>
            </div>

            <div class="mood-grid">
                @foreach (var mood in _moods)
                {
                    <div class="mood-item @(_journal.Mood == mood ? "active" : "")"
                         @onclick="() => _journal.Mood = mood">
                        <div class="mood-icon">
                            <i class="fa-solid @(Util.GetMoodIcon(mood))"></i>
                        </div>
                        <div class="mood-label">@mood.ToUpper()</div>
                    </div>
                }
            </div>
        </div>

        <div class="sidebar-card">
            <div class="card-header">
                <label>SECONDARY MOODS <span class="mood-limit">(Select up to 2)</span></label>
            </div>

            <div class="secondary-moods">
                @foreach (var mood in _moods)
                {
                    <label class="mood-chip @(_selectedSecondaryMoods.Contains(mood) ? "active" : "")">
                        <input type="checkbox"
                               checked="@_selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => ToggleSecondaryMood(mood, e)" />
                        <span>@mood</span>
                    </label>
                }
            </div>
        </div>

        <div class="sidebar-card">
            <div class="card-header">
                <label>TAGS</label>
            </div>
            <div class="tags-container">
                @foreach (var tag in _availableTags)
                {
                    <label class="tag-chip @(_selectedTags.Contains(tag) ? "active" : "")">
                        <input type="checkbox"
                               checked="@_selectedTags.Contains(tag)"
                               @onchange="e => ToggleTag(tag, e)" />
                        <span>@tag</span>
                    </label>
                }
            </div>
            <div class="tags-section">
                <input type="text"
                       class="tag-input"
                       placeholder="# Add tags (e.g. Health, Hobbies)..."
                       @bind="_newTagText" />
                <button @onclick="AddCustomTag" class="btn primary-btn">Add Tag</button>
            </div>
        </div>

    </div>

    <div class="journal-main">

        <div id="quill-toolbar" class="quill-toolbar">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>

            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>

            <select class="ql-header">
                <option value="1"></option>
                <option value="2"></option>
                <option selected></option>
            </select>

            <button class="ql-clean"></button>
        </div>

        <div class="editor-container">
            <input class="entry-title"
                   placeholder="Entry Title..."
                   @bind="_journal.Title" />

            <div id="editor"></div>

            <div class="word-count">0 words</div>
        </div>

        <button class="btn primary-btn btn-save"
                disabled="@_isLoading"
                @onclick="UpdateEntryAsync">
            @(_isLoading ? "Updating..." : "Update Entry")
        </button>

        <button class="btn btn-cancel"
                disabled="@_isLoading"
                @onclick="GoBack">
            Cancel
        </button>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <p class="error-msg">@_errorMessage</p>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private User? _currentUser;
    private JournalEntry _journal = new();
    private string _errorMessage = string.Empty;
    private bool _isLoading;

    private readonly List<string> _selectedTags = new();
    private readonly List<string> _selectedSecondaryMoods = new();

    private string _newTagText = string.Empty;

    private readonly List<string> _moods = new()
    {
        "Happy","Excited","Relaxed","Grateful","Confident",
        "Calm","Thoughtful","Curious","Nostalgic","Bored",
        "Sad","Angry","Stressed","Lonely","Anxious"
    };

    private readonly List<string> _availableTags = new()
    {
        "Work","Career","Studies","Family","Friends","Relationships",
        "Health","Fitness","Personal Growth","Self-care","Hobbies",
        "Travel","Nature","Finance","Spirituality","Birthday","Holiday",
        "Vacation","Celebration","Exercise","Reading","Writing","Cooking",
        "Meditation","Yoga","Music","Shopping","Parenting","Projects",
        "Planning","Reflection"
    };

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUser();
        if (_currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        _isLoading = true;

        var existing = await JournalService.GetJournalByIdAsync(Id);

        if (existing == null || existing.UserId != _currentUser.Id)
        {
            _isLoading = false;
            Navigation.NavigateTo("/journal/list");
            return;
        }

        _journal = existing;

        if (!string.IsNullOrWhiteSpace(_journal.SecondaryMood1))
            _selectedSecondaryMoods.Add(_journal.SecondaryMood1);

        if (!string.IsNullOrWhiteSpace(_journal.SecondaryMood2))
            _selectedSecondaryMoods.Add(_journal.SecondaryMood2);

        if (_journal.Tags != null)
        {
            foreach (var tag in _journal.Tags)
            {
                if (!_availableTags.Contains(tag))
                    _availableTags.Add(tag);

                if (!_selectedTags.Contains(tag))
                    _selectedTags.Add(tag);
            }
        }

        _isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await JS.InvokeVoidAsync("initQuill", "editor", "quill-toolbar");
        await JS.InvokeVoidAsync("setQuillHtml", _journal.Content ?? string.Empty);
    }

    private async Task UpdateEntryAsync()
    {
        _errorMessage = string.Empty;

        _journal.Content = await JS.InvokeAsync<string>("getQuillContent");

        if (string.IsNullOrWhiteSpace(_journal.Title) ||
            string.IsNullOrWhiteSpace(_journal.Content) ||
            string.IsNullOrWhiteSpace(_journal.Mood))
        {
            _errorMessage = "All fields must be filled.";
            return;
        }

        if (_selectedSecondaryMoods.Count != 2)
        {
            _errorMessage = "Please select 2 secondary moods.";
            return;
        }

        if (_currentUser is null)
        {
            _errorMessage = "User session is invalid. Please sign in again.";
            return;
        }

        _journal.SecondaryMood1 = _selectedSecondaryMoods[0];
        _journal.SecondaryMood2 = _selectedSecondaryMoods[1];
        _journal.UpdatedAt = DateTime.UtcNow;
        _journal.Tags = _selectedTags.ToList();
        _journal.WordCount = Util.GetWordCount(_journal.Content);
        _isLoading = true;

        var updated = await JournalService.UpdateJournalEntryAsync(
            _journal.Id,
            _journal.Title,
            _journal.Content,
            _journal.Mood,
            _journal.SecondaryMood1,
            _journal.SecondaryMood2,
            _journal.Tags,
            _currentUser.Id,
            _journal.WordCount,
            _journal.UpdatedAt
        );

        _isLoading = false;

        if (updated == null)
        {
            _errorMessage = "Update failed.";
            return;
        }

        Navigation.NavigateTo($"/journal/{_journal.Id}");
    }

    private void ToggleSecondaryMood(string mood, ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b && b;

        if (isChecked)
        {
            if (_selectedSecondaryMoods.Count < 2 && !_selectedSecondaryMoods.Contains(mood))
                _selectedSecondaryMoods.Add(mood);
        }
        else
        {
            _selectedSecondaryMoods.Remove(mood);
        }
    }

    private void ToggleTag(string tag, ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b && b;

        if (isChecked)
        {
            if (!_selectedTags.Contains(tag))
                _selectedTags.Add(tag);
        }
        else
        {
            _selectedTags.Remove(tag);
        }
    }

    private void AddCustomTag()
    {
        var tag = _newTagText?.Trim();

        if (!string.IsNullOrWhiteSpace(tag))
        {
            if (!_availableTags.Contains(tag))
                _availableTags.Add(tag);

            if (!_selectedTags.Contains(tag))
                _selectedTags.Add(tag);
        }

        _newTagText = string.Empty;
    }

    private void GoBack() => Navigation.NavigateTo($"/journal/{_journal.Id}");
}
