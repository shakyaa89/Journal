@page "/journal/edit/{Id:int}"
@using Journal.Models
@using Journal.Services
@inject NavigationManager Navigation
@inject IJournalService JournalService
@inject IAuthService AuthService

<div class="journal-container">
    <div class="journal-sidebar">

        <!-- Date -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>DATE</label>
            </div>
            <div class="date-picker">
                <span class="date-icon"><i class="fa-solid fa-calendar"></i></span>
                <div class="date-info">
                    <div class="date-text">@editJournal.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</div>
                    <div class="date-subtext">Original entry date</div>
                </div>
            </div>
        </div>

        <!-- Primary Mood -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>PRIMARY MOOD <span class="required">*</span></label>
            </div>

            <div class="mood-grid">
                @foreach (var mood in MoodsList)
                {
                    <div class="mood-item @(editJournal.Mood == mood ? "active" : "")"
                         @onclick="() => editJournal.Mood = mood">
                        <div class="mood-icon">
                            <i class="fa-solid fa-face-smile"></i>
                        </div>
                        <div class="mood-label">@mood.ToUpper()</div>
                    </div>
                }
            </div>
        </div>

        <!-- Secondary Moods -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>SECONDARY MOODS <span class="mood-limit">(Select 2)</span></label>
            </div>

            <div class="secondary-moods">
                @foreach (var mood in MoodsList)
                {
                    <label class="mood-chip @(selectedSecondaryMoods.Contains(mood) ? "active" : "")">
                        <input type="checkbox"
                               checked="@selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => ToggleSecondaryMood(mood, e)" />
                        <span>@mood</span>
                    </label>
                }
            </div>
        </div>

    </div>

    <div class="journal-main">

        <div class="editor-container">
            <input class="entry-title"
                   placeholder="Entry Title..."
                   @bind="editJournal.Title" />

            <textarea class="entry-content"
                      placeholder="Start writing your thoughts here..."
                      @bind="editJournal.Content"></textarea>

            <div class="word-count">0 words</div>
        </div>

        <button class="btn primary-btn btn-save"
                disabled="@isLoading"
                @onclick="UpdateEntryAsync">
            @(isLoading ? "Updating..." : "Update Entry")
        </button>

        <button class="btn btn-cancel"
                disabled="@isLoading"
                @onclick="GoToList">
            Cancel
        </button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="error-msg">@errorMessage</p>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private User? currentUser;
    private JournalEntry editJournal = new();
    private string errorMessage = string.Empty;
    private bool isLoading;

    private readonly List<string> MoodsList = new()
    {
        "Happy","Excited","Relaxed","Grateful","Confident","Calm",
        "Thoughtful","Curious","Nostalgic",
        "Bored","Sad","Angry","Stressed","Lonely","Anxious"
    };

    private List<string> selectedSecondaryMoods = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isLoading = true;

        var existing = await JournalService.GetJournalByIdAsync(Id);

        if (existing == null || existing.UserId != currentUser.Id)
        {
            Navigation.NavigateTo("/journal/list");
            return;
        }

        editJournal = existing;

        // Preselect existing secondary moods
        if (!string.IsNullOrWhiteSpace(editJournal.SecondaryMood1))
            selectedSecondaryMoods.Add(editJournal.SecondaryMood1);

        if (!string.IsNullOrWhiteSpace(editJournal.SecondaryMood2))
            selectedSecondaryMoods.Add(editJournal.SecondaryMood2);

        isLoading = false;
    }

    private void ToggleSecondaryMood(string mood, Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b && b;

        if (isChecked)
        {
            if (selectedSecondaryMoods.Count < 2 && !selectedSecondaryMoods.Contains(mood))
                selectedSecondaryMoods.Add(mood);
        }
        else
        {
            selectedSecondaryMoods.Remove(mood);
        }
    }

    private async Task UpdateEntryAsync()
    {
        errorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(editJournal.Title) ||
            string.IsNullOrWhiteSpace(editJournal.Content) ||
            string.IsNullOrWhiteSpace(editJournal.Mood))
        {
            errorMessage = "All fields must be filled.";
            return;
        }

        if (selectedSecondaryMoods.Count != 2)
        {
            errorMessage = "Please select exactly 2 secondary moods.";
            return;
        }

        editJournal.SecondaryMood1 = selectedSecondaryMoods[0];
        editJournal.SecondaryMood2 = selectedSecondaryMoods[1];

        isLoading = true;

        var updated = await JournalService.UpdateJournalEntryAsync(
            editJournal.Id,
            editJournal.Title,
            editJournal.Content,
            editJournal.Mood,
            editJournal.SecondaryMood1,
            editJournal.SecondaryMood2,
            currentUser!.Id
        );

        isLoading = false;

        if (updated == null)
        {
            errorMessage = "Update failed.";
            return;
        }

        Navigation.NavigateTo("/journal/list");
    }

    private void GoToList() => Navigation.NavigateTo("/journal/list");
}
