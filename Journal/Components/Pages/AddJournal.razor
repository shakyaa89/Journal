@page "/journal/add"
@using Journal.Models;
@using Journal.Services;
@inject NavigationManager Navigation
@inject JournalService JournalService
@inject AuthService AuthService

<div class="journal-container">
    <div class="journal-sidebar">
        <!-- Date & Time Section -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>DATE & TIME</label>
            </div>
            <div class="date-picker">
                <span class="date-icon"><i class="fa-solid fa-calendar"></i></span>
                <div class="date-info">
                    <div class="date-text">@DateTime.Now.ToString("MMM dd, yyyy")</div>
                    <div class="date-subtext">Today</div>
                </div>
            </div>
        </div>

        <!-- Primary Mood Section -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>PRIMARY MOOD <span class="required">*</span></label>
            </div>
            <div class="mood-grid">
                @foreach (var mood in MoodsList)
                {
                    <div class="mood-item @(newJournal.Mood == mood ? "active" : "")"
                         @onclick="() => newJournal.Mood = mood">
                        <div class="mood-icon"><i class="fa-solid fa-face-smile"></i></div>
                        <div class="mood-label">@mood.ToUpper()</div>
                    </div>
                }
            </div>
        </div>

        <!-- Secondary Moods Section -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>SECONDARY MOODS <span class="mood-limit">(Max 2)</span></label>
            </div>
            <div class="secondary-moods">
                @foreach (var mood in MoodsList)
                {
                    <label class="mood-chip @(selectedSecondaryMoods.Contains(mood) ? "active" : "")">
                        <input type="checkbox"
                               checked="@selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => ToggleSecondaryMood(mood, e)" />
                        <span>@mood</span>
                    </label>
                }
            </div>
        </div>

        <!-- Tags Section -->
        <div class="sidebar-card">
            <div class="card-header">
                <label>TAGS</label>
            </div>
            <div class="tags-section">
                <input type="text"
                       class="tag-input"
                       placeholder="# Add tags (e.g. Health, Hobbies)..." />
            </div>
        </div>

      
    </div>

    <div class="journal-main">
        <!-- Toolbar -->
        <div class="editor-toolbar">
            <div class="toolbar-left">
                <button class="toolbar-btn"><strong>B</strong></button>
                <button class="toolbar-btn"><em>I</em></button>
                <button class="toolbar-btn"><u>U</u></button>
                <button class="toolbar-btn">☰</button>
                <button class="toolbar-btn">≡</button>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn">⊕</button>
                <button class="toolbar-btn">⤢</button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor-container">
            <input type="text"
                   class="entry-title"
                   placeholder="Entry Title..."
                   @bind="newJournal.Title" />

            <textarea class="entry-content"
                      placeholder="Start writing your thoughts here..."
                      @bind="newJournal.Content"></textarea>

            <div class="word-count">0 words</div>
        </div>

        <button class="btn primary-btn btn-save" @onclick="SaveEntryAsync">
            Save Entry
        </button>
        <button class="btn btn-cancel" @onclick="GoToList">Cancel</button>


        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="error-msg">@errorMessage</p>
        }
    </div>
</div>


@code {
    private JournalEntry newJournal = new JournalEntry();
    private string errorMessage = string.Empty;

    private List<string> AvailableTags = new List<string> { "Work", "Career", "Studies", "Family", "Friends", "Relationships", "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel", "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation", "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation", "Yoga", "Music", "Shopping", "Parenting", "Projects", "Planning", "Reflection" };

    private List<string> MoodsList = new List<string> { "Happy", "Excited", "Relaxed", "Grateful", "Confident", "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored", "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

    private List<string> selectedSecondaryMoods = new();

    private void ToggleSecondaryMood(string mood, ChangeEventArgs e)
    {
        var isChecked = (bool)e.Value;

        if (isChecked)
        {
            if (selectedSecondaryMoods.Count < 2 && !selectedSecondaryMoods.Contains(mood))
                selectedSecondaryMoods.Add(mood);
        }
        else
        {
            selectedSecondaryMoods.Remove(mood);
        }
    }

    




    private async Task SaveEntryAsync()
    {
        var today = DateTime.Now.Date;

        try
        {
            var journals = await JournalService.GetAllJournalsAsync(currentUser!.Id);
            bool existsToday = journals.Any(j => j.CreatedAt.Date == today);

            if (string.IsNullOrEmpty(newJournal.Title) || string.IsNullOrEmpty(newJournal.Content)) 
            {
                errorMessage = "All fields must be filled.";
                return;
            }

            if (existsToday)
            {
                errorMessage = "You can only create one journal entry per day.";
                return;
            }

            if (string.IsNullOrWhiteSpace(newJournal.Mood))
            {
                errorMessage = "Please select a mood.";
                return;
            }

            if (selectedSecondaryMoods.Count != 2)
            {
                errorMessage = "Please select exactly 2 secondary moods.";
                return;
            }


            


            if (!string.IsNullOrWhiteSpace(newJournal.Title) && !string.IsNullOrWhiteSpace(newJournal.Content))
            {
                newJournal.SecondaryMood1 = selectedSecondaryMoods[0];
                newJournal.SecondaryMood2 = selectedSecondaryMoods[1];


                await JournalService.AddJournalEntryAsync(
                    newJournal.Title,
                    newJournal.Content,
                    newJournal.Mood,
                    newJournal.SecondaryMood1,
                    newJournal.SecondaryMood2,
                    currentUser.Id
                );

                newJournal = new JournalEntry();
                errorMessage = string.Empty;
                selectedSecondaryMoods.Clear();
                Navigation.NavigateTo("/journal/list");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}, {ex.InnerException?.Message}";
            Console.WriteLine(ex.Message);
        }
    }


    private void GoToList() => Navigation.NavigateTo("/journal/list");


    private User? currentUser;

    protected override void OnInitialized()
    {
        currentUser = AuthService.GetCurrentUser();

        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }
    }

}