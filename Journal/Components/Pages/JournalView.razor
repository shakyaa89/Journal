@page "/journal/{Id:int}"
@using Journal.Models
@using System.Text.RegularExpressions
@using System.IO
@using Microsoft.Maui.Storage
@using Journal.Services
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject IPDFService PDFService

<div class="journal-view-container">
    @if (_entry == null)
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading journal entry...</p>
        </div>
    }
    else
    {
        <div class="journal-view-content">
            <div class="view-header">
                <a class="btn-back" href="/journal/list">
                    <span class="back-icon">
                        <i class="fa-solid fa-arrow-left"></i>
                    </span>
                    <span>Back to Journals</span>
                </a>

                <button class="btn-edit" @onclick="ExportPdf" disabled="@_isExporting">
                    <span class="edit-icon">
                        <i class="fa-solid fa-file-pdf"></i>
                    </span>
                    <span>@(_isExporting ? "Exporting..." : "Export to PDF")</span>
                </button>
            </div>

            <div class="journal-card">
                <div class="mood-section">
                    @if (!string.IsNullOrWhiteSpace(_entry.Mood))
                    {
                        <div class="primary-mood">
                            <span class="mood-label">Primary Mood</span>
                            <span class="mood-badge primary">@_entry.Mood</span>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(_entry.SecondaryMood1) || !string.IsNullOrWhiteSpace(_entry.SecondaryMood2))
                    {
                        <div class="secondary-moods">
                            <span class="mood-label">Also Feeling</span>
                            <div class="mood-badges">
                                @if (!string.IsNullOrWhiteSpace(_entry.SecondaryMood1))
                                {
                                    <span class="mood-badge secondary">@_entry.SecondaryMood1</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(_entry.SecondaryMood2))
                                {
                                    <span class="mood-badge secondary">@_entry.SecondaryMood2</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="journal-header">
                    <h1 class="journal-title">@_entry.Title</h1>
                    <div class="journal-meta">
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-calendar-days"></i>
                            </span>
                            @_entry.CreatedAt.ToLocalTime().ToString("dddd, MMM dd yyyy")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-clock"></i>
                            </span>
                            @_entry.CreatedAt.ToLocalTime().ToString("hh:mm tt")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-rotate-right"></i>
                            </span>
                            @_entry.UpdatedAt.ToLocalTime().ToString("hh:mm tt")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-file-lines"></i>
                            </span>
                            @_entry.WordCount words
                        </span>
                    </div>
                </div>

                @if (_entry.Tags != null && _entry.Tags.Count > 0)
                {
                    <div class="tags-section">
                        <span class="tags-label">Tags</span>
                        <div class="tags-list">
                            @foreach (var tag in _entry.Tags)
                            {
                                <span class="tag-badge">
                                    @tag
                                </span>
                            }
                        </div>
                    </div>
                }

                <div class="content-divider"></div>

                <div class="journal-content">
                    @((MarkupString)_entry.Content)
                </div>
            </div>

            <div class="btn-container">
                <button class="btn primary-btn" @onclick="() => NavigateTo(_entry.Id)">
                    <i class="fa-solid fa-pen"></i>Update Journal
                </button>
                <button class="btn primary-btn del-btn" @onclick="() => DeleteJournal(_entry.Id)">
                    <i class="fa-solid fa-trash"></i>Delete Journal
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private bool _isExporting;
    private JournalEntry? _entry;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntryAsync();
    }

    private void NavigateTo(int id)
    {
        Navigation.NavigateTo($"/journal/edit/{id}");
    }

    private async Task LoadEntryAsync()
    {
        _entry = await JournalService.GetJournalByIdAsync(Id);
    }

    private async Task DeleteJournal(int id)
    {
        var confirmDelete = await ShowDeleteAlertAsync();
        if (!confirmDelete)
            return;

        var deleted = await JournalService.DeleteJournalAsync(id);
        if (!deleted) return;

        await Application.Current!.Windows[0].Page!.DisplayAlert("Success", "Journal deleted successfully.", "OK");
        Navigation.NavigateTo("/journal/list");
    }

    private async Task<bool> ShowDeleteAlertAsync()
    {
        return await Application.Current!.Windows[0].Page!.DisplayAlert(
            "Confirm Deletion",
            "Are you sure you want to delete this journal?",
            "Yes",
            "No"
        );
    }

    private async Task ExportPdf()
    {
        if (_entry is null || string.IsNullOrWhiteSpace(_entry.Content))
            return;

        _isExporting = true;

        try
        {
            var pdfBytes = PDFService.GeneratePdf(_entry);

            var safeTitle = string.IsNullOrWhiteSpace(_entry.Title) ?
            "JournalEntry" 
            : string.Concat(_entry.Title.Split(Path.GetInvalidFileNameChars()));

            var downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");

            var filePath = Path.Combine(downloadsPath, $"{safeTitle}.pdf");

            File.WriteAllBytes(filePath, pdfBytes);

            await Application.Current!.Windows[0].Page!.DisplayAlert("Success", "PDF saved to Downloads folder.", "OK");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error exporting PDF: {ex.Message}");
            await Application.Current!.Windows[0].Page!.DisplayAlert("Error", "Failed to export PDF", "OK");
        }
        finally
        {
            _isExporting = false;
        }
    }
}
