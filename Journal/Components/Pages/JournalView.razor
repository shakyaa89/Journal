@page "/journal/{Id:int}"
@using Journal.Models
@using System.Text.RegularExpressions
@using System.IO
@using Microsoft.Maui.Storage
@using Journal.Services
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject IPDFService PDFService

<div class="journal-view-container">
    @if (Entry == null)
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading journal entry...</p>
        </div>
    }
    else
    {
        <div class="journal-view-content">
            <!-- Header with Back Button -->
            <div class="view-header">
                <a class="btn-back" href="/journal/list">
                    <span class="back-icon">
                        <i class="fa-solid fa-arrow-left"></i>
                    </span>
                    <span>Back to Journals</span>
                </a>
                
                <button class="btn-edit" @onclick="@ExportPdf">
                    <span class="edit-icon">
                        <i class="fa-solid fa-file-pdf"></i>
                    </span>
                    <span>@(isExporting ? "Exporting..." : "Export to PDF")</span>
                </button>
            </div>

            <!-- Journal Card -->
            <div class="journal-card">
                <!-- Mood Section -->
                <div class="mood-section">
                    @if (!string.IsNullOrWhiteSpace(Entry.Mood))
                    {
                        <div class="primary-mood">
                            <span class="mood-label">Primary Mood</span>
                            <span class="mood-badge primary">@Entry.Mood</span>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood1) || !string.IsNullOrWhiteSpace(Entry.SecondaryMood2))
                    {
                        <div class="secondary-moods">
                            <span class="mood-label">Also Feeling</span>
                            <div class="mood-badges">
                                @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood1))
                                {
                                    <span class="mood-badge secondary">@Entry.SecondaryMood1</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood2))
                                {
                                    <span class="mood-badge secondary">@Entry.SecondaryMood2</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Title and Meta -->
                <div class="journal-header">
                    <h1 class="journal-title">@Entry.Title</h1>
                    <div class="journal-meta">
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-calendar-days"></i>
                            </span>
                            @Entry.CreatedAt.ToLocalTime().ToString("dddd, MMM dd yyyy")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-clock"></i>
                            </span>
                            @Entry.CreatedAt.ToLocalTime().ToString("hh:mm tt")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-rotate-right"></i>
                            </span>
                            @Entry.UpdatedAt.ToLocalTime().ToString("hh:mm tt")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-file-lines"></i>
                            </span>
                            @GetWordCount(Entry.Content) words
                        </span>
                    </div>
                </div>

                <!-- Tags Section -->
                @if (Entry.Tags != null && Entry.Tags.Count > 0)
                {
                    <div class="tags-section">
                        <span class="tags-label">Tags</span>
                        <div class="tags-list">
                            @foreach (string tag in Entry.Tags)
                            {
                                <span class="tag-badge">
                                    @tag
                                </span>
                            }
                        </div>
                    </div>
                }

                <!-- Divider -->
                <div class="content-divider"></div>

                <!-- Journal Content -->
                <div class="journal-content">
                    @((MarkupString)Entry.Content)
                </div>
            </div>

            <div class="btn-container">
                <button class="btn primary-btn" @onclick="@(() => NavigateTo(Entry.Id))"><i class="fa-solid fa-pen"></i>Update Journal</button>
                <button class="btn primary-btn del-btn" @onclick="() => DeleteJournal(Entry.Id)"><i class="fa-solid fa-trash"></i>Delete Journal</button>

            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }
    private bool isExporting = false;
    private JournalEntry? Entry;

    protected override async Task OnInitializedAsync()
    {
        await FetchJournalsAsync();
    }

    private void NavigateTo(int id)
    {
        Navigation.NavigateTo($"/journal/edit/{id}");
    }

    private async Task FetchJournalsAsync()
    {
        Entry = await JournalService.GetJournalByIdAsync(Id);

    }

    private async Task DeleteJournal(int id)
    {
        bool confirmDelete = await ShowDeleteAlertAsync();
        if (!confirmDelete) return;

        bool deleted = await JournalService.DeleteJournalAsync(id);
        if (deleted)
        {
            Navigation.NavigateTo("/journal/list");
            await Application.Current!.Windows[0].Page!.DisplayAlertAsync("Success", "Journal deleted successfully.", "OK");
        }
    }

    private async Task<bool> ShowDeleteAlertAsync()
    {
        bool confirmation = await Application.Current!.Windows[0].Page!.DisplayAlertAsync(
            title: "Confirm Deletion",
            message: "Are you sure you want to delete this jounal?",
            accept: "Yes",
            cancel: "No"
        );

        return confirmation;
    }

    private int GetWordCount(string? html)
    {
        if (string.IsNullOrWhiteSpace(html))
            return 0;

        var text = Regex.Replace(html, "<.*?>", " ");
        text = Regex.Replace(text, @"\s+", " ").Trim();

        return string.IsNullOrEmpty(text) ? 0 : text.Split(' ').Length;
    }

    private async Task ExportPdf()
    {
        isExporting = true;
        try
        {
            if (Entry is null || string.IsNullOrWhiteSpace(Entry.Content))
                return;

            var pdfBytes = PDFService.GeneratePdf(Entry);

            var downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
            var filePath = Path.Combine(downloadsPath, $"{Entry.Title}.pdf");

            File.WriteAllBytes(filePath, pdfBytes);

            await Application.Current!.Windows[0].Page!.DisplayAlertAsync("Success", "PDF saved to Downloads folder.", "OK");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error exporting PDF: {ex.Message}");
            await Application.Current!.Windows[0].Page!.DisplayAlertAsync("Error", "Failed to export PDF", "OK");
        }
        finally
        {
            isExporting = false;
        }
    }
}
