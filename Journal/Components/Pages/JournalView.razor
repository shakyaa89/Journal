@page "/journal/{Id:int}"
@using Journal.Models
@using System.Text.RegularExpressions;
@inject IJournalService JournalService
@inject NavigationManager Navigation


<div class="journal-view-container">
    @if (Entry == null)
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading journal entry...</p>
        </div>
    }
    else
    {
        <div class="journal-view-content">
            <!-- Header with Back Button -->
            <div class="view-header">
                <button class="btn-back" @onclick="@(() => Navigation.NavigateTo("/journal/list"))">
                    <span class="back-icon">
                        <i class="fa-solid fa-arrow-left"></i>
                    </span>
                    <span>Back to Journals</span>
                </button>
                <button class="btn-edit" @onclick="@(() => NavigateTo(Entry.Id))">
                    <span class="edit-icon">
                        <i class="fa-solid fa-pen"></i>
                    </span>
                    <span>Edit</span>
                </button>
            </div>

            <!-- Journal Card -->
            <div class="journal-card">
                <!-- Mood Section -->
                <div class="mood-section">
                    @if (!string.IsNullOrWhiteSpace(Entry.Mood))
                    {
                        <div class="primary-mood">
                            <span class="mood-label">Primary Mood</span>
                            <span class="mood-badge primary">@Entry.Mood</span>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood1) || !string.IsNullOrWhiteSpace(Entry.SecondaryMood2))
                    {
                        <div class="secondary-moods">
                            <span class="mood-label">Also Feeling</span>
                            <div class="mood-badges">
                                @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood1))
                                {
                                    <span class="mood-badge secondary">@Entry.SecondaryMood1</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(Entry.SecondaryMood2))
                                {
                                    <span class="mood-badge secondary">@Entry.SecondaryMood2</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Title and Meta -->
                <div class="journal-header">
                    <h1 class="journal-title">@Entry.Title</h1>
                    <div class="journal-meta">
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-calendar-days"></i>
                            </span>
                            @Entry.CreatedAt.ToLocalTime().ToString("dddd, MMM dd yyyy")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-clock"></i>
                            </span>
                            @Entry.CreatedAt.ToLocalTime().ToString("hh:mm tt")
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">
                                <i class="fa-solid fa-file-lines"></i>
                            </span>
                            @GetWordCount(Entry.Content) words
                        </span>
                    </div>
                </div>

                <!-- Tags Section -->
                @if (Entry.Tags != null && Entry.Tags.Count > 0)
                {
                    <div class="tags-section">
                        <span class="tags-label">Tags</span>
                        <div class="tags-list">
                            @foreach (string tag in Entry.Tags)
                            {
                                <span class="tag-badge">
                                    @tag
                                </span>
                            }
                        </div>
                    </div>
                }

                <!-- Divider -->
                <div class="content-divider"></div>

                <!-- Journal Content -->
                <div class="journal-content">
                    @((MarkupString)Entry.Content)
                </div>
            </div>
        </div>
    }
</div>


@code {
    [Parameter]
    public int Id { get; set; }

    private JournalEntry? Entry;

    protected override async Task OnInitializedAsync()
    {
        Entry = await JournalService.GetJournalByIdAsync(Id);
    }

    private void NavigateTo(int id)
    {
        Navigation.NavigateTo($"/journal/edit/{id}");
    }

    private int GetWordCount(string? html)
    {
        if (string.IsNullOrWhiteSpace(html))
            return 0;

        var text = Regex.Replace(html, "<.*?>", " ");
        text = Regex.Replace(text, @"\s+", " ").Trim();

        return string.IsNullOrEmpty(text) ? 0 : text.Split(' ').Length;
    }
}
