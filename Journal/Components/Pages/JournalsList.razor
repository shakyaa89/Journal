@page "/journal/list"
@using Journal.Models
@using Journal.Services
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IPDFService PDFService


<div class="journal-list-page">
    <div class="list-header">
        <h1>Your Journal Entries</h1>
        <p class="header-subtitle">@FilteredJournals.Count @(FilteredJournals.Count == 1 ? "entry" : "entries") total</p>
    </div>

    <div class="journal-filters">
        <div class="filter-row">
            <input type="text"
                   placeholder="Search by title or content"
                   @bind="_searchText"
                   @bind:event="oninput" />

            <select @bind="_selectedMood">
                <option value="">All moods</option>
                @foreach (var mood in _moodOptions)
                {
                    <option value="@mood">@mood</option>
                }
            </select>

            <input type="text"
                   placeholder="Filter by tag"
                   @bind="_tagFilter"
                   @bind:event="oninput" />
        </div>

        <div class="filter-row">
            <label>
                From:
                <input type="date"
                       @bind="_startDate"
                       @bind:format="yyyy-MM-dd" />
            </label>

            <label>
                To:
                <input type="date"
                       @bind="_endDate"
                       @bind:format="yyyy-MM-dd" />
            </label>

            <button @onclick="ClearFilters" class="btn primary-btn">Clear filters</button>
            <button @onclick="ExportPdf" class="btn primary-btn">Export entries as PDF</button>

        </div>
    </div>

    <div class="view-switch">
        <button class="btn @(_isCalendarView ? "view-toggle" : "primary-btn")"
                @onclick="() => _isCalendarView = false">
            List View
        </button>
        <button class="btn  @(_isCalendarView ? "primary-btn" : "view-toggle")"
                @onclick="() => _isCalendarView = true">
            Calendar View
        </button>
    </div>

    @if (_isCalendarView)
    {
        <div class="calendar-container">
            <div class="calendar-header">
                <button class="calendar-nav-btn" @onclick="PrevMonth"><i class="fa-solid fa-angle-left"></i></button>
                <span class="calendar-title">@CalendarMonthName</span>
                <button class="calendar-nav-btn" @onclick="NextMonth"><i class="fa-solid fa-angle-right"></i></button>
            </div>

            <div class="calendar-grid">
                <div class="calendar-grid-header">Sun</div>
                <div class="calendar-grid-header">Mon</div>
                <div class="calendar-grid-header">Tue</div>
                <div class="calendar-grid-header">Wed</div>
                <div class="calendar-grid-header">Thu</div>
                <div class="calendar-grid-header">Fri</div>
                <div class="calendar-grid-header">Sat</div>

                @foreach (var week in _calendarWeeks)
                {
                    @foreach (var day in week)
                    {
                        if (day == null)
                        {
                            <div class="calendar-cell empty"></div>
                        }
                        else
                        {
                            var date = new DateTime(_calendarYear, _calendarMonth, day.Value);
                            var entry = FilteredJournals
                            .Where(j => j.CreatedAt.Date == date.Date)
                            .OrderByDescending(j => j.CreatedAt)
                            .FirstOrDefault();

                            if (entry != null)
                            {
                                <div class="calendar-cell has-entry">
                                    <button class="calendar-entry-btn"
                                            @onclick="() => ViewJournal(entry.Id)">
                                        <div class="calendar-day-number">@day.Value</div>
                                        <div class="calendar-entry-title">@entry.Title</div>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="calendar-cell">
                                    <div class="calendar-day-number">@day.Value</div>
                                </div>
                            }
                        }
                    }
                }
            </div>
        </div>
    }
    else
    {
        @if (!FilteredJournals.Any())
        {
            <div class="empty-state">
                <h2>No journal entries yet</h2>
                <p>Start documenting your thoughts and experiences</p>
                <a href="/journal/add" class="btn-add-first">Create Your First Entry</a>
            </div>
        }
        else
        {
            <div class="journal-grid">
                @foreach (var journal in PagedJournals)
                {
                    <div class="journal-card">
                        <div class="card-top">
                            <div class="journal-date-badge">
                                <span class="date-day">@journal.CreatedAt.ToString("dd")</span>
                                <span class="date-month">@journal.CreatedAt.ToString("MMM")</span>
                            </div>

                            @if (!string.IsNullOrEmpty(journal.Mood))
                            {
                                <div class="mood-badge">
                                    <span class="mood-emoji">
                                        <i class="fa-solid @(Util.GetMoodIcon(journal.Mood))"></i>
                                    </span>
                                    <span class="mood-text">@journal.Mood</span>
                                </div>
                            }
                        </div>

                        <h3 class="journal-title">@journal.Title</h3>
                        <p class="journal-preview">@((MarkupString)GetPreview(journal.Content))</p>

                        @if (journal.Tags != null && journal.Tags.Count > 0)
                        {
                            <div class="journal-tags-container">
                                @foreach (var tag in journal.Tags.Take(5))
                                {
                                    <div class="tag-badge">
                                        <span class="tag-text">@tag</span>
                                    </div>
                                }
                            </div>
                        }

                        <div class="card-footer">
                            <span class="journal-time">@journal.UpdatedAt.ToLocalTime().ToString("h:mm tt")</span>
                            <button class="btn-read-more" @onclick="() => ViewJournal(journal.Id)">View Journal</button>
                        </div>
                    </div>
                }
            </div>

            @if (TotalPages > 1)
            {
                <div class="pagination">
                    <button class="page-btn"
                            disabled="@CurrentPage.Equals(1)"
                            @onclick="PrevPage">
                        Prev
                    </button>

                    @foreach (var p in PageNumbers)
                    {
                        <button class="page-number @(p == CurrentPage ? "active" : "")"
                                @onclick="() => GoToPage(p)">
                            @p
                        </button>
                    }

                    <button class="page-btn"
                            disabled="@CurrentPage.Equals(TotalPages)"
                            @onclick ="NextPage">
                        Next
                    </button>
                </div>
            }
        }
    }

    <div class="floating-add-btn">
        <a href="/journal/add" class="btn-add-new">
            <span class="add-icon"><i class="fa-solid fa-plus"></i></span>
            <span>New Entry</span>
        </a>
    </div>
</div>

@code {
    private User? _currentUser;
    private List<JournalEntry> _journals = new();

    private bool _isExporting;

    private int _pageSize = 6;
    private int _currentPage = 1;

    private bool _isCalendarView;

    private int _calendarYear = DateTime.Today.Year;
    private int _calendarMonth = DateTime.Today.Month;
    private readonly List<int?[]> _calendarWeeks = new();

    private string CalendarMonthName =>
        new DateTime(_calendarYear, _calendarMonth, 1).ToString("MMMM yyyy");

    private string _searchText = string.Empty;
    private string _selectedMood = string.Empty;
    private string _tagFilter = string.Empty;
    private DateTime? _startDate;
    private DateTime? _endDate;

    private readonly List<string> _moodOptions = new()
    {
        "Happy", "Excited", "Relaxed", "Grateful", "Confident",
        "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored",
        "Sad", "Angry", "Stressed", "Lonely", "Anxious"
    };

    private List<JournalEntry> FilteredJournals => GetFilteredJournals();

    private int TotalPages => FilteredJournals.Count == 0 ? 0 : (int)Math.Ceiling(FilteredJournals.Count / (double)_pageSize);

    private int CurrentPage => _currentPage;

    private IEnumerable<int> PageNumbers => TotalPages == 0 ? Enumerable.Empty<int>() : Enumerable.Range(1, TotalPages);

    private List<JournalEntry> PagedJournals => FilteredJournals.OrderByDescending(j => j.CreatedAt).Skip((CurrentPage - 1) * _pageSize).Take(_pageSize).ToList();

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUser();
        if (_currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await FetchJournalsAsync();
        CalendarView();
    }

    private async Task FetchJournalsAsync()
    {
        if (_currentUser != null)
            _journals = await JournalService.GetAllJournalsAsync(_currentUser.Id);

        if (TotalPages > 0 && _currentPage > TotalPages)
            _currentPage = TotalPages;
        else if (TotalPages == 0)
            _currentPage = 1;
    }

    private List<JournalEntry> GetFilteredJournals()
    {
        IEnumerable<JournalEntry> query = _journals;

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var text = _searchText.Trim();
            query = query.Where(j => (!string.IsNullOrEmpty(j.Title) && j.Title.Contains(text, StringComparison.OrdinalIgnoreCase)) || (!string.IsNullOrEmpty(j.Content) && j.Content.Contains(text, StringComparison.OrdinalIgnoreCase)));
        }

        if (_startDate.HasValue)
        {
            var from = _startDate.Value.Date;
            query = query.Where(j => j.CreatedAt.Date >= from);
        }

        if (_endDate.HasValue)
        {
            var to = _endDate.Value.Date;
            query = query.Where(j => j.CreatedAt.Date <= to);
        }

        if (!string.IsNullOrWhiteSpace(_selectedMood))
        {
            var mood = _selectedMood.Trim();
            query = query.Where(j =>
                !string.IsNullOrEmpty(j.Mood) &&
                string.Equals(j.Mood, mood, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(_tagFilter))
        {
            var tagText = _tagFilter.Trim();
            query = query.Where(j =>
                j.Tags != null &&
                j.Tags.Any(t => !string.IsNullOrEmpty(t) && t.Contains(tagText, StringComparison.OrdinalIgnoreCase)));
        }

        return query.ToList();
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return string.Empty;

        return content.Length > 20 ? content[..20] + "..." : content;
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _selectedMood = string.Empty;
        _tagFilter = string.Empty;
        _startDate = null;
        _endDate = null;
        _currentPage = 1;
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages)
            return;

        _currentPage = page;
    }

    private void PrevPage()
    {
        if (_currentPage > 1)
            _currentPage--;
    }

    private void NextPage()
    {
        if (_currentPage < TotalPages)
            _currentPage++;
    }

    private void CalendarView()
    {
        _calendarWeeks.Clear();

        var firstOfMonth = new DateTime(_calendarYear, _calendarMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(_calendarYear, _calendarMonth);

        var offset = (int)firstOfMonth.DayOfWeek;
        var currentDay = 1 - offset;

        for (var week = 0; week < 6; week++)
        {
            var weekDays = new int?[7];

            for (var dayIndex = 0; dayIndex < 7; dayIndex++)
            {
                if (currentDay < 1 || currentDay > daysInMonth)
                    weekDays[dayIndex] = null;
                else
                    weekDays[dayIndex] = currentDay;

                currentDay++;
            }

            _calendarWeeks.Add(weekDays);

            if (currentDay > daysInMonth)
                break;
        }
    }

    private void PrevMonth()
    {
        var dt = new DateTime(_calendarYear, _calendarMonth, 1).AddMonths(-1);
        _calendarYear = dt.Year;
        _calendarMonth = dt.Month;
        CalendarView();
    }

    private void NextMonth()
    {
        var dt = new DateTime(_calendarYear, _calendarMonth, 1).AddMonths(1);
        _calendarYear = dt.Year;
        _calendarMonth = dt.Month;
        CalendarView();
    }

    private void ViewJournal(int id)
    {
        Navigation.NavigateTo($"/journal/{id}");
    }


    private async Task ExportPdf()
    {
        var entries = FilteredJournals;

        if (entries == null || entries.Count == 0)
            return;

        _isExporting = true;

        try
        {
            var pdfBytes = PDFService.GeneratePdf(entries);

            var fileName = $"JournalEntries-{DateTime.Now:yyyyMMddHHmmss}";
            var downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");

            var filePath = Path.Combine(downloadsPath, $"{fileName}.pdf");

            File.WriteAllBytes(filePath, pdfBytes);

            await Application.Current!.Windows[0].Page!.DisplayAlertAsync("Success", "PDF saved to Downloads folder.", "OK");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            _isExporting = false;
        }
    }

}
