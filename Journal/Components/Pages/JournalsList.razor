@page "/journal/list"
@using Journal.Models
@using Journal.Services
@using MudBlazor
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<div class="journal-list-page">
    <div class="list-header">
        <h1>Your Journal Entries</h1>
        <p class="header-subtitle">@FilteredJournals.Count @(FilteredJournals.Count == 1 ? "entry" : "entries") total</p>
    </div>

    <div class="journal-filters">
        <div class="filter-row">
            <input type="text"
                   placeholder="Search by title or content"
                   @bind="SearchText"
                   @bind:event="oninput" />

            <select @bind="SelectedMood">
                <option value="">All moods</option>
                @foreach (var mood in MoodOptions)
                {
                    <option value="@mood">@mood</option>
                }
            </select>

            <input type="text"
                   placeholder="Filter by tag"
                   @bind="TagFilter"
                   @bind:event="oninput" />
        </div>

        <div class="filter-row">
            <label>
                From:
                <input type="date"
                       @bind="StartDate"
                       @bind:format="yyyy-MM-dd" />
            </label>

            <label>
                To:
                <input type="date"
                       @bind="EndDate"
                       @bind:format="yyyy-MM-dd" />
            </label>

            <button @onclick="ClearFilters" class="btn primary-btn">Clear filters</button>
        </div>
    </div>

    <div class="view-switch">
        <button class="btn @(IsCalendarView ? "view-toggle" : "primary-btn")"
                @onclick="() => IsCalendarView = false">
            List View
        </button>
        <button class="btn  @(IsCalendarView ? "primary-btn" : "view-toggle")"
                @onclick="() => IsCalendarView = true">
            Calendar View
        </button>
    </div>

    @if (IsCalendarView)
    {
        <div class="calendar-container">
            <div class="calendar-header">
                <button class="calendar-nav-btn" @onclick="PrevMonth">&#x276E;</button>
                <span class="calendar-title">@CalendarMonthName</span>
                <button class="calendar-nav-btn" @onclick="NextMonth">&#x276F;</button>
            </div>

            <div class="calendar-grid">
                <div class="calendar-grid-header">Sun</div>
                <div class="calendar-grid-header">Mon</div>
                <div class="calendar-grid-header">Tue</div>
                <div class="calendar-grid-header">Wed</div>
                <div class="calendar-grid-header">Thu</div>
                <div class="calendar-grid-header">Fri</div>
                <div class="calendar-grid-header">Sat</div>

                @foreach (var week in CalendarWeeks)
                {
                    @foreach (var day in week)
                    {
                        if (day == null)
                        {
                            <div class="calendar-cell empty"></div>
                        }
                        else
                        {
                            var date = new DateTime(CalendarYear, CalendarMonth, day.Value);
                            var entry = FilteredJournals
                            .Where(j => j.CreatedAt.Date == date.Date)
                            .OrderByDescending(j => j.CreatedAt)
                            .FirstOrDefault();

                            if (entry != null)
                            {
                                <div class="calendar-cell has-entry">
                                    <button class="calendar-entry-btn"
                                            @onclick="() => ViewJournal(entry.Id)">
                                        <div class="calendar-day-number">@day.Value</div>
                                        <div class="calendar-entry-title">@entry.Title</div>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="calendar-cell">
                                    <div class="calendar-day-number">@day.Value</div>
                                </div>
                            }
                        }
                    }
                }
            </div>
        </div>
    }
    else
    {
        @if (!FilteredJournals.Any())
        {
            <div class="empty-state">
                <h2>No journal entries yet</h2>
                <p>Start documenting your thoughts and experiences</p>
                <a href="/journal/add" class="btn-add-first">Create Your First Entry</a>
            </div>
        }
        else
        {
            <div class="journal-grid">
                @foreach (var journal in PagedJournals)
                {
                    <div class="journal-card">
                        <div class="card-top">
                            <div class="journal-date-badge">
                                <span class="date-day">@journal.CreatedAt.ToString("dd")</span>
                                <span class="date-month">@journal.CreatedAt.ToString("MMM")</span>
                            </div>

                            @if (!string.IsNullOrEmpty(journal.Mood))
                            {
                                <div class="mood-badge">
                                    <span class="mood-emoji"><i class="fa-solid @(GetMoodIcon(journal.Mood))"></i></span>
                                    <span class="mood-text">@journal.Mood</span>
                                </div>
                            }
                        </div>

                        <h3 class="journal-title">@journal.Title</h3>
                        <p class="journal-preview">@((MarkupString)@GetPreview(journal.Content))</p>

                        @if (journal.Tags != null && journal.Tags.Count > 0)
                        {
                            <div class="journal-tags-container">
                                @foreach (var tag in journal.Tags.Take(5))
                                {
                                    <div class="tag-badge">
                                        <span class="tag-text">@tag</span>
                                    </div>
                                }
                            </div>
                        }

                        <div class="card-footer">
                            <span class="journal-time">@journal.CreatedAt.ToString("h:mm tt")</span>
                            <button class="btn-read-more" @onclick="() => ViewJournal(journal.Id)">View Journal</button>
                            <button class="btn-read-more" @onclick="() => DeleteJournal(journal.Id)">Delete Journal</button>
                        </div>
                    </div>
                }
            </div>

            @if (TotalPages > 1)
            {
                <div class="pagination">
                    <button class="page-btn"
                            disabled="@(CurrentPage == 1)"
                            @onclick="PrevPage">
                        Prev
                    </button>

                    @foreach (var p in PageNumbers)
                    {
                        <button class="page-number @(p == CurrentPage ? "active" : "")"
                                @onclick="() => GoToPage(p)">
                            @p
                        </button>
                    }

                    <button class="page-btn"
                            disabled="@(CurrentPage == TotalPages)"
                            @onclick="NextPage">
                        Next
                    </button>
                </div>
            }
        }
    }

    <div class="floating-add-btn">
        <a href="/journal/add" class="btn-add-new">
            <span class="add-icon"><i class="fa-solid fa-plus"></i></span>
            <span>New Entry</span>
        </a>
    </div>
</div>

@code {
    private User? currentUser;
    private List<JournalEntry> journals = new();

    private int PageSize = 6;
    private int CurrentPage = 1;

    // calendar toggle
    private bool IsCalendarView = false;

    // calendar state
    private int CalendarYear = DateTime.Today.Year;
    private int CalendarMonth = DateTime.Today.Month;
    private List<int?[]> CalendarWeeks = new();

    private string CalendarMonthName =>
        new DateTime(CalendarYear, CalendarMonth, 1).ToString("MMMM yyyy");

    // simple filter fields
    private string SearchText = string.Empty;
    private string SelectedMood = string.Empty;
    private string TagFilter = string.Empty;
    private DateTime? StartDate;
    private DateTime? EndDate;

    private readonly List<string> MoodOptions = new()
    {
        "Happy", "Excited", "Relaxed", "Grateful", "Confident",
        "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored",
        "Sad", "Angry", "Stressed", "Lonely", "Anxious"
    };

    private List<JournalEntry> FilteredJournals => GetFilteredJournals();

    private int TotalPages => (int)Math.Ceiling(FilteredJournals.Count / (double)PageSize);

    private IEnumerable<int> PageNumbers => TotalPages == 0
        ? Enumerable.Empty<int>()
        : Enumerable.Range(1, TotalPages);

    private List<JournalEntry> PagedJournals =>
        FilteredJournals
            .OrderByDescending(j => j.CreatedAt)
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await FetchJournalsAsync();
        CalendarView();
    }

    private async Task FetchJournalsAsync()
    {
        if (currentUser != null)
            journals = await JournalService.GetAllJournalsAsync(currentUser.Id);

        if (CurrentPage > TotalPages)
            CurrentPage = Math.Max(1, TotalPages == 0 ? 1 : TotalPages);
    }

    private List<JournalEntry> GetFilteredJournals()
    {
        List<JournalEntry> query = journals;

        // text search
        if (!string.IsNullOrWhiteSpace(SearchText))
        {
            string text = SearchText.Trim();
            query = query.Where(j =>
                (!string.IsNullOrEmpty(j.Title) &&
                 j.Title.Contains(text, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(j.Content) &&
                 j.Content.Contains(text, StringComparison.OrdinalIgnoreCase))).ToList();
        }

        // date range
        if (StartDate.HasValue)
        {
            DateTime from = StartDate.Value.Date;
            query = query.Where(j => j.CreatedAt.Date >= from).ToList();
        }

        if (EndDate.HasValue)
        {
            DateTime to = EndDate.Value.Date;
            query = query.Where(j => j.CreatedAt.Date <= to).ToList();
        }

        // mood
        if (!string.IsNullOrWhiteSpace(SelectedMood))
        {
            string mood = SelectedMood.Trim();
            query = query.Where(j =>
                !string.IsNullOrEmpty(j.Mood) &&
                string.Equals(j.Mood, mood, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        // tag
        if (!string.IsNullOrWhiteSpace(TagFilter))
        {
            string tagText = TagFilter.Trim();
            query = query.Where(j =>
                j.Tags != null &&
                j.Tags.Any(t =>
                    !string.IsNullOrEmpty(t) &&
                    t.Contains(tagText, StringComparison.OrdinalIgnoreCase))).ToList();
        }

        return query;
    }

    private void ClearFilters()
    {
        SearchText = string.Empty;
        SelectedMood = string.Empty;
        TagFilter = string.Empty;
        StartDate = null;
        EndDate = null;
        CurrentPage = 1;
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
    }

    private void PrevPage()
    {
        if (CurrentPage > 1)
            CurrentPage--;
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
            CurrentPage++;
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        return content.Length > 60 ? content.Substring(0, 20) + "..." : content;
    }

    private void ViewJournal(int id)
    {
        Navigation.NavigateTo($"/journal/{id}");
    }

    private async Task<bool> ShowDeleteAlertAsync()
    {
        bool confirmation = await Application.Current!.MainPage!.DisplayAlert(
            title: "Confirm Deletion",
            message: "Are you sure you want to delete this jounal?",
            accept: "Yes",
            cancel: "No"
        );

        return confirmation;
    }

    private async Task DeleteJournal(int id)
    {
        bool confirmDelete = await ShowDeleteAlertAsync();
        if (!confirmDelete) return;

        bool deleted = await JournalService.DeleteJournalAsync(id);
        if (deleted)
        {
            await FetchJournalsAsync();
            CalendarView();
        }
    }

    private string GetMoodIcon(string moods)
    {
        List<string> positiveMoods = new() { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
        List<string> neutralMoods = new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
        List<string> negativeMoods = new() { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

        if (positiveMoods.Contains(moods))
            return "fa-face-smile";
        else if (neutralMoods.Contains(moods))
            return "fa-face-meh";
        else if (negativeMoods.Contains(moods))
            return "fa-face-frown";

        return "fa-face-smile";
    }

    private void CalendarView()
    {
        CalendarWeeks.Clear();

        var firstOfMonth = new DateTime(CalendarYear, CalendarMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(CalendarYear, CalendarMonth);

        int offset = (int)firstOfMonth.DayOfWeek;

        int currentDay = 1 - offset;

        for (int week = 0; week < 6; week++)
        {
            var weekDays = new int?[7];

            for (int dayIndex = 0; dayIndex < 7; dayIndex++)
            {
                if (currentDay < 1 || currentDay > daysInMonth)
                    weekDays[dayIndex] = null;
                else
                    weekDays[dayIndex] = currentDay;

                currentDay++;
            }

            CalendarWeeks.Add(weekDays);

            if (currentDay > daysInMonth)
                break;
        }
    }

    private void PrevMonth()
    {
        var dt = new DateTime(CalendarYear, CalendarMonth, 1).AddMonths(-1);
        CalendarYear = dt.Year;
        CalendarMonth = dt.Month;
        CalendarView();
    }

    private void NextMonth()
    {
        var dt = new DateTime(CalendarYear, CalendarMonth, 1).AddMonths(1);
        CalendarYear = dt.Year;
        CalendarMonth = dt.Month;
        CalendarView();
    }
}
