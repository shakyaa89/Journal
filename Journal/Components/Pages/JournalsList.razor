@page "/journal/list"
@using Journal.Models
@using Journal.Services
@inject IJournalService JournalService;
@inject IAuthService AuthService;
@inject NavigationManager Navigation;

<div class="journal-list-page">
    <div class="list-header">
        <h1>Your Journal Entries</h1>
        <p class="header-subtitle">@journals?.Count @(journals?.Count == 1 ? "entry" : "entries") total</p>
    </div>

    @if (journals == null || journals.Count == 0)
    {
        <div class="empty-state">
            <h2>No journal entries yet</h2>
            <p>Start documenting your thoughts and experiences</p>
            <a href="/journal/add" class="btn-add-first">Create Your First Entry</a>
        </div>
    }
    else
    {
        <div class="journal-grid">
            @foreach (var journal in PagedJournals)
            {
                <div class="journal-card">
                    <div class="card-top">
                        <div class="journal-date-badge">
                            <span class="date-day">@journal.CreatedAt.ToString("dd")</span>
                            <span class="date-month">@journal.CreatedAt.ToString("MMM")</span>
                        </div>

                        @if (!string.IsNullOrEmpty(journal.Mood))
                        {
                            <div class="mood-badge">
                                <span class="mood-emoji"><i class="fa-solid @(GetMoodIcon(journal.Mood))"></i></span>
                                <span class="mood-text">@journal.Mood</span>
                            </div>
                        }
                    </div>

                    <h3 class="journal-title">@journal.Title</h3>
                    <p class="journal-preview">@((MarkupString)@GetPreview(journal.Content))</p>

                    @if(journal.Tags != null && journal.Tags.Count > 0)
                    {
                        <div class="journal-tags-container">
                            @foreach (var tag in journal.Tags.Take(5))
                            {
                                <div class="tag-badge">
                                    <span class="tag-text">@tag</span>
                                </div>
                            }
                        </div>
                    }

                    <div class="card-footer">
                        <span class="journal-time">@journal.CreatedAt.ToString("h:mm tt")</span>
                        <button class="btn-read-more" @onclick="() => ViewJournal(journal.Id)">View Journal</button>
                        <button class="btn-read-more" @onclick="() => DeleteJournal(journal.Id)">Delete Journal</button>
                    </div>
                </div>
            }
        </div>

        @if (TotalPages > 1)
        {
            <div class="pagination">
                <button class="page-btn"
                        disabled="@(CurrentPage == 1)"
                        @onclick="PrevPage">
                    Prev
                </button>

                @foreach (var p in PageNumbers)
                {
                    <button class="page-number @(p == CurrentPage ? "active" : "")"
                            @onclick="() => GoToPage(p)">
                        @p
                    </button>
                }

                <button class="page-btn"
                        disabled="@(CurrentPage == TotalPages)"
                        @onclick="NextPage">
                    Next
                </button>
            </div>
        }
    }

    <div class="floating-add-btn">
        <a href="/journal/add" class="btn-add-new">
            <span class="add-icon"><i class="fa-solid fa-plus"></i></span>
            <span>New Entry</span>
        </a>
    </div>
</div>

@code {
    private User? currentUser;
    private List<JournalEntry> journals = new();

    private int PageSize = 6; 

    private int CurrentPage = 1;

    private int TotalPages => (int)Math.Ceiling(journals.Count / (double)PageSize);

    private IEnumerable<int> PageNumbers => Enumerable.Range(1, TotalPages);

    private List<JournalEntry> PagedJournals =>
        journals
            .OrderByDescending(j => j.CreatedAt)
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize).ToList();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUser();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await FetchJournalsAsync();
    }

    private async Task FetchJournalsAsync()
    {
        if (currentUser != null)
            journals = await JournalService.GetAllJournalsAsync(currentUser.Id);

        if (CurrentPage > TotalPages)
            CurrentPage = Math.Max(1, TotalPages);
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
    }

    private void PrevPage()
    {
        if (CurrentPage > 1)
            CurrentPage--;
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
            CurrentPage++;
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        return content.Length > 60 ? content.Substring(0, 20) + "..." : content;
    }

    private void ViewJournal(int id)
    {
        Navigation.NavigateTo($"/journal/{id}");
    }

    private async Task<bool> ShowDeleteAlertAsync()
    {
        bool confirmation = await (Application.Current!.MainPage!.DisplayAlert(
            title: "Confirm Deletion",
            message: "Are you sure you want to delete this jounal?",
            accept: "Yes",
            cancel: "No"
        ));

        return confirmation;
    }

    private async Task DeleteJournal(int id)
    {
        bool confirmDelete = await ShowDeleteAlertAsync();
        if (!confirmDelete) return;

        bool deleted = await JournalService.DeleteJournalAsync(id);
        if (deleted)
            await FetchJournalsAsync();
    }

    private string GetMoodIcon(string moods)
    {
        List<string> positiveMoods = new List<string> { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
        List<string> neutralMoods = new List<string> { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
        List<string> negativeMoods = new List<string> { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

        if (positiveMoods.Contains(moods))
            return "fa-face-smile";
        else if (neutralMoods.Contains(moods))
            return "fa-face-meh";
        else if (negativeMoods.Contains(moods))
            return "fa-face-frown";

        return "fa-face-smile";
    }
}
