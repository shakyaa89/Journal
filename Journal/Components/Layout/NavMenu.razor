@using Journal.Services
@using Journal.Models
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IThemeService ThemeService


<div class="app-sidebar">
    <div class="app-sidebar-header">
        <div class="app-user-info">
            <div class="app-user-avatar">
                @GetUserInitials()
            </div>
            <div class="app-user-details">
                <span class="app-user-name">@(currentUser?.FullName ?? "Guest")</span>
                <span class="app-user-id">ID: @currentUser?.Id</span>
            </div>
        </div>
    </div>
    <div class="app-sidebar-main-container">
    <nav class="app-sidebar-nav">
        <ul class="app-sidebar-list">
            <li class="app-sidebar-item">
                <a href="/dashboard" class="app-sidebar-link" @onclick='() => Navigate("/dashboard")' >
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="app-sidebar-text">Dashboard</span>
                </a>
            </li>
            <li class="app-sidebar-item">
                <a href="/journal/list" class="app-sidebar-link" @onclick='() => Navigate("/journal/list")'>
                    <i class="fa-solid fa-book"></i>
                    <span class="app-sidebar-text">Journals</span>
                </a>
            </li>
            <li class="app-sidebar-item">
                <a href="/journal/add" class="app-sidebar-link" @onclick='() => Navigate("/journal/add")'>
                    <i class="fa-solid fa-plus"></i>
                    <span class="app-sidebar-text">New Entry</span>
                </a>
            </li>
           
        </ul>
    </nav>
        <nav class="app-sidebar-nav app-sidebar-bottom">
            <ul class="app-sidebar-list">
                <li class="app-sidebar-item">
                    <a class="app-sidebar-link app-sidebar-bottom-btn" @onclick='() => ChangeTheme()'>
                        @if(theme == "dark")
                        {
                            <i class="fa-solid fa-moon"></i>
                        }
                        else
                        {
                            <i class="fa-solid fa-sun"></i>
                        }
                        <span class="app-sidebar-text">Change Theme</span>
                    </a>
                    <a class="app-sidebar-link app-sidebar-bottom-btn" @onclick='() => LogoutAsync()'>
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                        <span class="app-sidebar-text">Logout</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

@code {
    private User? currentUser;

    private string theme = "dark";

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUser();
        theme = await ThemeService.GetCurrentThemeAsync();
    }

    private void Navigate(string path)
    {
        NavigationManager.NavigateTo(path);
    }

    private string GetUserInitials()
    {
        if (currentUser?.FullName == null) return "?";
        var parts = currentUser.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return currentUser.FullName.Length > 0 ? currentUser.FullName[0].ToString().ToUpper() : "?";
    }

    private async Task<bool> ShowLogoutAlertAsync()
    {
        bool confirmation = await (Application.Current!.MainPage!.DisplayAlertAsync(
            title: "Confirm Logout",
            message: "Are you sure you want to logout?",
            accept: "Yes",
            cancel: "No"
        ));

        return confirmation;
    }

    private async Task LogoutAsync()
    {
        if(await ShowLogoutAlertAsync())
        {
            AuthService.LogoutUser();
        }
        else
        {
            return;
        }

        NavigationManager.NavigateTo("/login");
    }

    private async Task ChangeTheme()
    {
        string currentTheme = await ThemeService.GetCurrentThemeAsync();

        if(string.IsNullOrEmpty(currentTheme))
        {
            currentTheme = "dark";
        }

        string nextTheme = currentTheme == "dark" ? "light" : "dark";

        theme = nextTheme;
        
        await ThemeService.SetThemeAsync(nextTheme);

        StateHasChanged();

        NavigationManager.NavigateTo(
            NavigationManager.Uri,
            forceLoad: false
        );
    }
}